<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE log4j:configuration SYSTEM "log4j.dtd">

<!-- Log4j 1.x XML配置示例：OSS日志上传配置 -->
<log4j:configuration xmlns:log4j="http://jakarta.apache.org/log4j/" debug="false">

    <!-- 控制台Appender -->
    <appender name="console" class="org.apache.log4j.ConsoleAppender">
        <param name="Target" value="System.out"/>
        <layout class="org.apache.log4j.PatternLayout">
            <param name="ConversionPattern" value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5p %c{1} - %m%n"/>
        </layout>
    </appender>

    <!-- OSS Appender：上传日志到对象存储 -->
    <appender name="oss" class="org.logx.log4j.Log4jOSSAppender">
        <!-- S3兼容存储配置 - 必需参数 -->
        <param name="endpoint" value="${LOGX_OSS_ENDPOINT:-https://oss-cn-hangzhou.aliyuncs.com}"/>
        <param name="region" value="${LOGX_OSS_REGION:-cn-hangzhou}"/>
        <param name="accessKeyId" value="${LOGX_OSS_ACCESS_KEY_ID}"/>
        <param name="accessKeySecret" value="${LOGX_OSS_ACCESS_KEY_SECRET}"/>
        <param name="bucket" value="my-app-logs"/>

        <!-- 应用行为配置 - 可选参数 -->
        <param name="keyPrefix" value="logs/application/"/>
        <param name="maxQueueSize" value="100000"/>
        <param name="maxBatchCount" value="1000"/>
        <param name="maxBatchBytes" value="2097152"/><!-- 2MB -->
        <param name="maxMessageAgeMs" value="600000"/>
        <param name="dropWhenQueueFull" value="false"/>
        <param name="multiProducer" value="false"/>
        <param name="maxRetries" value="3"/>
        <param name="baseBackoffMs" value="200"/>
        <param name="maxBackoffMs" value="10000"/>

        <!-- 日志格式Layout -->
        <layout class="org.apache.log4j.PatternLayout">
            <param name="ConversionPattern" value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5p %c{1} - %m%n"/>
        </layout>

        <!-- 过滤器：只记录ERROR及以上级别 -->
        <filter class="org.apache.log4j.varia.LevelRangeFilter">
            <param name="LevelMin" value="ERROR"/>
            <param name="LevelMax" value="FATAL"/>
        </filter>
    </appender>

    <!-- 根Logger配置 -->
    <root>
        <priority value="INFO"/>
        <appender-ref ref="console"/>
        <appender-ref ref="oss"/>
    </root>

    <!-- 特定Logger配置：业务日志单独上传 -->
    <logger name="com.mycompany.business" additivity="false">
        <level value="DEBUG"/>
        <appender-ref ref="console"/>
        <appender-ref ref="oss"/>
    </logger>

</log4j:configuration>
