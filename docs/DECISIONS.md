# 项目决策记录 (Architectural Decision Records)

本文档记录LogX OSS Appender项目的重要架构和功能决策，避免未来重复讨论已决定的事项。

---

## ADR-001: MVP版本不实现监控和告警接口

**日期**: 2025-10-05
**状态**: ✅ 已决定
**决策人**: 项目组

### 背景

PRD Epic 2故事点4中提到"数据丢失监控和告警接口"，但在代码实现阶段未实现此功能。

### 决策

**不在当前MVP版本实现监控和告警接口**，理由：

1. **核心可靠性机制已满足需求**：
   - ✅ 失败重试策略（ExponentialBackoffRetry，最多5次重试）
   - ✅ 兜底文件机制（网络异常时本地缓存，定时重传）
   - ✅ 优雅关闭保护（30秒超时保护，确保数据不丢失）
   - ✅ 资源保护策略（固定线程池、低优先级调度、CPU让出）

2. **监控需求的复杂性**：
   - 不同用户对监控的需求差异很大
   - 企业环境通常已有完善的监控系统（Prometheus、ELK等）
   - 过早引入监控接口可能限制用户的集成灵活性

3. **MVP版本聚焦核心功能**：
   - 优先保证日志上传的可靠性和性能
   - 监控接口可以在后续版本根据用户反馈设计

### 后果

- **正面**：简化MVP实现，加快交付速度
- **负面**：用户需要通过日志或外部工具监控组件状态
- **缓解措施**：提供详细的日志输出，方便用户集成到现有监控系统

### 未来计划

如果用户有强烈需求，可在v2.0版本中考虑添加：
- 指标接口（Metrics API）：暴露队列深度、上传成功率等指标
- 回调接口（Callback API）：允许用户注册失败处理器
- JMX支持：通过JMX MBeans暴露运行时指标

### 相关测试

无需添加测试，因为功能不实现。

---

## ADR-002: MVP版本不实现动态自适应批处理算法

**日期**: 2025-10-05
**状态**: ✅ 已决定
**决策人**: 项目组

### 背景

在设计批处理优化时，曾考虑实现基于网络延迟、系统负载、队列深度的智能自适应批处理算法。

### 决策

**不在当前MVP版本实现动态自适应批处理**，使用固定配置参数，理由：

1. **固定配置已满足核心需求**：
   - 用户可配置三个触发条件：`maxBatchCount`（消息数）、`maxBatchBytes`（字节数）、`maxMessageAgeMs`（消息年龄）
   - 这三个参数已覆盖绝大多数使用场景
   - 性能测试证明固定配置可达到24,777+ 消息/秒的吞吐量

2. **自适应算法的复杂性**：
   - 需要大量测试验证自适应策略的有效性
   - 不同业务场景的最优参数差异很大，很难找到通用算法
   - 自适应调整可能引入不可预测的性能波动

3. **配置参数已提供足够灵活性**：
   ```java
   // 用户可以根据实际情况调整参数
   maxBatchCount = 8192;      // 建议范围：100-50000
   maxBatchBytes = 10485760;  // 建议范围：1MB-100MB
   maxMessageAgeMs = 60000;   // 建议范围：1秒-30分钟
   ```

4. **KISS原则**：
   - Keep It Simple, Stupid
   - 简单的固定配置更容易理解、调试和维护
   - 减少出错的可能性

### 后果

- **正面**：降低实现复杂度，提高系统稳定性
- **负面**：用户需要手动调优参数
- **缓解措施**：在文档中提供详细的参数调优指南和最佳实践

### 配置清理

已从文档中删除以下误导性配置：
- ~~`enableAdaptiveSize`~~ - 此参数从未实现，已从README.md删除

### 未来计划

如果用户有强烈需求，可在v2.0版本中考虑添加：
- 预设配置模式（低延迟模式、高吞吐模式、平衡模式）
- 简单的自适应策略（基于队列深度的动态调整）

### 相关测试

现有的`AsyncEngineIntegrationTest`已验证固定配置的有效性，无需添加额外测试。

---

## ADR-003: 默认region值使用"ap-guangzhou"

**日期**: 2025-10-05
**状态**: ✅ 已验证
**决策人**: 项目组

### 背景

PRD要求默认region为"ap-guangzhou"（广州区域），需要确保代码实现与PRD一致。

### 决策

**使用"ap-guangzhou"作为默认region值**，符合PRD FR3要求。

### 实现

```java
// CommonConfig.Defaults.java
public static final String REGION = "ap-guangzhou";

// StorageConfig.Builder.java
private String region = CommonConfig.Defaults.REGION;
```

### 验证

已在`ConfigCompatibilityTest.shouldUseCorrectDefaultRegionValue()`中添加测试验证：
```java
assertThat(CommonConfig.Defaults.REGION).isEqualTo("ap-guangzhou");
```

### 后果

用户如果使用其他区域（如cn-hangzhou、us-west-1），需要显式配置region参数。

---

## 决策记录更新流程

1. **何时添加决策记录**：
   - 重大架构变更
   - 功能范围确定（实现/不实现）
   - 默认值选择
   - 技术选型

2. **决策记录格式**：
   - 标题：简短描述决策内容
   - 日期、状态、决策人
   - 背景：为什么需要做这个决策
   - 决策：具体决定是什么，包括理由
   - 后果：决策的影响（正面、负面、缓解措施）
   - 未来计划：如果需要重新考虑，在什么情况下
   - 相关测试：如何验证这个决策

3. **状态说明**：
   - ✅ 已决定：决策已做出并执行
   - 🔄 进行中：决策正在讨论
   - ❌ 已废弃：决策已被后续决策替代

---

**最后更新**: 2025-10-05
