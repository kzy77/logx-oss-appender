# Story 1.3: 实现阿里云OSS适配器

## Status
Draft

## Story
**As a** 使用阿里云OSS的开发者，
**I want** 有OSS的具体实现适配器，
**so that** 可以将日志上传到阿里云对象存储。

## Acceptance Criteria
1. 实现OSSStorageAdapter类，继承S3StorageAdapter接口
2. 集成阿里云OSS SDK，配置endpoint和credentials
3. 实现putObject方法，支持批量上传和单个上传
4. 添加OSS特定的错误处理和重试逻辑
5. 编写OSS连接和上传的单元测试

## Tasks / Subtasks

- [ ] Task 1: 创建OSSStorageAdapter核心类 (AC: 1)
  - [ ] 在log-java-producer模块创建OSSStorageAdapter类
  - [ ] 继承S3StorageInterface接口（来自故事1.2）
  - [ ] 实现StorageBackend.OSS枚举支持
  - [ ] 添加类级别Javadoc说明OSS集成功能
  - [ ] 确保类命名符合org.logx包命名规范

- [ ] Task 2: 集成阿里云OSS SDK配置 (AC: 2)
  - [ ] 添加Aliyun OSS SDK 3.17.4依赖到父POM
  - [ ] 创建OSSStorageConfig配置类继承S3StorageConfig
  - [ ] 配置OSS特定参数：endpoint、region、accessKeyId、accessKeySecret
  - [ ] 实现OSS客户端初始化逻辑，支持endpoint自动检测
  - [ ] 添加连接超时和读取超时配置

- [ ] Task 3: 实现putObject核心上传方法 (AC: 3)
  - [ ] 实现putObject(String key, byte[] data)单个对象上传
  - [ ] 实现putObjects(Map<String, byte[]> objects)批量上传方法
  - [ ] 添加对象键命名规范：支持时间戳和随机后缀
  - [ ] 实现Content-Type自动检测（application/x-ndjson）
  - [ ] 支持gzip压缩上传优化传输效率

- [ ] Task 4: 实现OSS特定错误处理和重试 (AC: 4)
  - [ ] 实现OSSException特定异常处理逻辑
  - [ ] 集成指数退避重试策略（最大3次）
  - [ ] 添加OSS服务器错误分类：5xx重试，4xx不重试
  - [ ] 实现连接错误和超时的特殊处理
  - [ ] 添加详细的错误日志记录，包含OSS错误码

- [ ] Task 5: 实现健康检查和连接验证 (AC: 1, 2)
  - [ ] 实现healthCheck()方法验证OSS连接状态
  - [ ] 添加bucket存在性检查逻辑
  - [ ] 实现权限验证：测试读写权限
  - [ ] 添加网络连通性检测
  - [ ] 提供连接状态诊断信息

- [ ] Task 6: 编写综合单元测试 (AC: 5)
  - [ ] 创建OSSStorageAdapterTest测试类
  - [ ] 测试正常上传流程：单个和批量上传
  - [ ] 模拟OSS服务器错误和网络异常
  - [ ] 测试重试逻辑和错误处理正确性
  - [ ] 验证配置参数验证和异常情况
  - [ ] 达到>90%代码覆盖率要求

## Dev Notes

### 依赖故事关系
**直接依赖**: 故事1.2（S3统一存储接口设计）必须完成，提供S3StorageInterface基础接口

**为后续故事准备**: 本OSS适配器实现将为故事1.6的健康检查功能提供具体的连接验证能力

### 技术栈和架构背景
**阿里云OSS SDK**: Aliyun OSS SDK 3.17.4，S3兼容模式下的主要目标平台 [Source: architecture.md#技术栈表]

**存储策略**: 多云S3兼容，优先OSS支持 [Source: architecture.md#云基础设施]

**分层抽象架构**: log-java-producer作为高度抽象的核心层，提供基于S3标准的统一存储接口 [Source: architecture.md#技术概要]

### OSS集成技术要求
**S3兼容性**: 基于S3标准，支持OSS/S3/MinIO [Source: architecture.md#S3StorageInterface]

**网络要求**: HTTPS强制，TLS 1.2+ [Source: architecture.md#云基础设施]

**认证方式**: IAM Access Key/Secret Key [Source: architecture.md#云基础设施]

### 配置管理
**统一命名空间**: 基于org.logx统一包命名，确保简洁的组织标识 [Source: architecture.md#技术栈表]

**配置示例参考**:
```xml
<appender name="OSS" class="org.logx.{framework}.OSSAppender">
    <!-- 必需参数 -->
    <endpoint>https://oss-cn-hangzhou.aliyuncs.com</endpoint>
    <accessKey>${OSS_ACCESS_KEY}</accessKey>
    <secretKey>${OSS_SECRET_KEY}</secretKey>
    <bucketName>my-log-bucket</bucketName>
</appender>
```
[Source: architecture.md#配置示例]

**环境变量支持**:
```bash
export OSS_ACCESS_KEY="your-access-key"
export OSS_SECRET_KEY="your-secret-key"
export OSS_BUCKET_NAME="your-bucket-name"
export OSS_ENDPOINT="https://oss-cn-hangzhou.aliyuncs.com"
```
[Source: architecture.md#环境变量]

### 错误处理和重试策略
**重试策略**: 失败重试3次，指数退避算法 [Source: architecture.md#DisruptorBatchingQueue]

**错误分类**: 需要区分可重试错误（网络、超时、5xx）和不可重试错误（认证、权限、4xx）

**错误日志示例**:
```java
logger.error("OSS upload failed after 3 retries",
    "batch_size={}, endpoint={}, error={}",
    batchSize, endpoint, exception.getMessage());
```
[Source: architecture.md#错误处理]

### 性能优化要求
**性能监控**:
```java
logger.info("OSS appender performance: avg_latency={}ms, throughput={}/s",
    avgLatency, throughput);
```
[Source: architecture.md#性能监控]

**压缩优化**: 支持gzip压缩以优化网络传输效率

### 文件位置和结构
**模块位置**: log-java-producer模块 [Source: architecture.md#核心组件设计]

**包结构建议**:
- 适配器实现: `log-java-producer/src/main/java/org/logx/storage/oss/`
- 配置类: `log-java-producer/src/main/java/org/logx/config/oss/`
- 异常类: `log-java-producer/src/main/java/org/logx/exception/oss/`
- 测试文件: `log-java-producer/src/test/java/org/logx/storage/oss/`

### 集成测试注意事项
**多云兼容性**: 后续需要与AWS S3适配器（故事1.4）保持接口一致性

**集成测试**: 需要支持真实OSS环境的集成测试验证

### Testing
**测试框架**: JUnit 5.10.1 [Source: architecture.md#技术栈表]
**断言库**: AssertJ 3.24.2 [Source: architecture.md#技术栈表]
**静态分析**: SpotBugs 4.8.3确保高质量代码交付 [Source: architecture.md#技术栈表]
**测试覆盖要求**: 单元测试覆盖率 > 90%，重点测试核心组件 [Source: architecture.md#测试覆盖]

**OSS特定测试要求**:
- OSS SDK集成正确性测试
- 网络异常和服务器错误模拟测试
- 重试逻辑和退避算法验证
- 配置参数边界值和异常情况测试
- 性能基准测试：延迟和吞吐量验证
- 真实OSS环境的集成测试（可选，需要测试环境）

**测试Mock策略**: 使用Mockito模拟OSS客户端，避免依赖真实OSS服务进行单元测试

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-20 | 1.0 | Initial story creation for Aliyun OSS adapter implementation | Bob (Scrum Master) |

## Dev Agent Record
_(This section is populated by the development agent during implementation)_

### Agent Model Used
_(To be filled by dev agent)_

### Debug Log References
_(To be filled by dev agent)_

### Completion Notes List
_(To be filled by dev agent)_

### File List
_(To be filled by dev agent)_

## QA Results
_(Results from QA Agent QA review of the completed story implementation)_