# Story 1.5: 基础配置管理框架

## Status
Draft

## Story
**As a** 系统集成者，
**I want** 有统一的配置管理框架，
**so that** 可以简化不同存储后端的配置工作。

## Acceptance Criteria
1. 创建ConfigManager类，支持从环境变量和配置文件读取参数
2. 实现配置验证机制，确保必需参数完整性
3. 支持配置热加载和错误恢复
4. 提供配置示例文件和文档
5. 编写配置管理的单元测试

## Tasks / Subtasks

- [ ] Task 1: 设计ConfigManager核心类 (AC: 1)
  - [ ] 在log-java-producer模块创建ConfigManager类
  - [ ] 实现环境变量读取：System.getenv()和System.getProperty()
  - [ ] 实现配置文件读取：支持Properties和YAML格式
  - [ ] 添加配置优先级：JVM参数 > 环境变量 > 配置文件 > 默认值
  - [ ] 实现配置键命名规范和转换逻辑

- [ ] Task 2: 实现统一配置验证机制 (AC: 2)
  - [ ] 创建ConfigValidator接口定义验证规范
  - [ ] 实现必需参数完整性检查
  - [ ] 添加参数格式验证：URL、端口、凭据格式等
  - [ ] 实现跨参数依赖验证：endpoint与region一致性
  - [ ] 提供详细的验证错误信息和修复建议

- [ ] Task 3: 实现配置热加载和错误恢复 (AC: 3)
  - [ ] 设计配置变更监听机制
  - [ ] 实现配置文件热加载：FileWatcher监控变更
  - [ ] 添加配置变更校验：新配置验证通过才应用
  - [ ] 实现错误恢复：配置失败时回滚到上一个有效配置
  - [ ] 添加配置变更事件通知机制

- [ ] Task 4: 创建存储后端配置抽象 (AC: 1, 2)
  - [ ] 设计StorageConfig基类，定义通用配置接口
  - [ ] 实现OSSConfig和S3Config具体配置类
  - [ ] 添加配置工厂模式：ConfigFactory.create(StorageBackend)
  - [ ] 实现配置模板和默认值管理
  - [ ] 支持配置继承和覆盖机制

- [ ] Task 5: 提供配置示例和文档 (AC: 4)
  - [ ] 创建application.properties配置示例文件
  - [ ] 创建application.yml配置示例文件
  - [ ] 编写环境变量配置指南文档
  - [ ] 提供Spring Boot集成配置示例
  - [ ] 创建配置故障排除和最佳实践文档

- [ ] Task 6: 编写配置管理单元测试 (AC: 5)
  - [ ] 创建ConfigManagerTest测试类
  - [ ] 测试配置读取优先级和覆盖逻辑
  - [ ] 模拟配置验证失败和错误恢复场景
  - [ ] 测试热加载机制和配置变更监听
  - [ ] 验证不同存储后端配置的正确性
  - [ ] 达到>90%代码覆盖率要求

## Dev Notes

### 依赖故事关系
**服务于**: 故事1.3（OSS适配器）和故事1.4（S3适配器）的配置管理需求

**集成于**: 故事1.6（健康检查）将使用配置管理进行连接验证

### 配置管理架构设计
**统一配置策略**: 单一核心包+灵活配置，避免starter包碎片化 [Source: PRD v3.0#统一依赖策略]

**配置优先级设计**:
1. JVM系统属性 (-Doss.endpoint=xxx)
2. 环境变量 (OSS_ENDPOINT=xxx)
3. 配置文件属性 (application.properties)
4. 代码默认值

### 技术栈和框架兼容性
**零侵入集成**: 支持Spring Boot、JSP、Servlet、Struts、JSF等多框架 [Source: brownfield-architecture.md#多框架兼容性]

**Java 8兼容性**: 确保企业环境的广泛可用性 [Source: architecture.md#技术栈表]

**Maven构建集成**: 基于统一的父POM管理 [Source: architecture.md#技术栈表]

### 配置键命名规范
**OSS配置示例**:
```properties
# 阿里云OSS配置
oss.endpoint=https://oss-cn-hangzhou.aliyuncs.com
oss.accessKeyId=${OSS_ACCESS_KEY_ID}
oss.accessKeySecret=${OSS_ACCESS_KEY_SECRET}
oss.bucket=my-log-bucket
oss.keyPrefix=app-logs/
```
[Source: architecture.md#配置示例]

**S3配置示例**:
```properties
# AWS S3配置
aws.s3.region=us-east-1
aws.s3.accessKeyId=${AWS_ACCESS_KEY_ID}
aws.s3.secretAccessKey=${AWS_SECRET_ACCESS_KEY}
aws.s3.bucket=my-log-bucket
aws.s3.keyPrefix=app-logs/
```

### 多框架集成支持
**Spring Boot集成**:
```yaml
# application.yml
logging:
  config: classpath:logback-spring.xml

# 环境变量配置（推荐生产环境）
OSS_ENDPOINT: https://oss-cn-hangzhou.aliyuncs.com
OSS_ACCESS_KEY_ID: ${OSS_AK}
OSS_ACCESS_KEY_SECRET: ${OSS_SK}
OSS_BUCKET: my-app-logs
```
[Source: brownfield-architecture.md#Spring Boot集成]

**JSP/Servlet集成**:
```xml
<!-- web.xml 配置 -->
<context-param>
    <param-name>oss.endpoint</param-name>
    <param-value>${CATALINA_BASE}/conf/oss.properties</param-value>
</context-param>
```
[Source: brownfield-architecture.md#JSP/Servlet集成]

### 配置验证策略
**参数完整性**: 验证必需参数（endpoint、credentials、bucket）的存在性

**格式验证**:
- URL格式：endpoint必须是有效的HTTPS URL
- 凭据格式：accessKey长度和格式验证
- 网络连通性：endpoint可达性检查

**业务逻辑验证**:
- 区域一致性：endpoint与region的匹配验证
- 权限验证：通过简单API调用验证凭据有效性

### 错误处理和恢复
**配置错误分类**:
- 格式错误：参数格式不正确，提供修复建议
- 网络错误：endpoint不可达，提供诊断信息
- 权限错误：凭据无效或权限不足，提供权限检查指南

**错误恢复策略**:
- 配置验证失败时保持上一个有效配置
- 提供配置回滚机制和版本管理
- 记录详细的配置变更和错误日志

### 安全考虑
**敏感信息保护**:
```yaml
# 生产环境推荐配置方式
OSS_ACCESS_KEY_ID: ${SECRET_OSS_AK}      # 从K8s Secret注入
OSS_ACCESS_KEY_SECRET: ${SECRET_OSS_SK}  # 从K8s Secret注入
OSS_ENDPOINT: https://oss-prod.company.com
OSS_BUCKET: prod-app-logs-${HOSTNAME}    # 按主机名分桶
```
[Source: brownfield-architecture.md#敏感信息保护]

### 文件位置和结构
**模块位置**: log-java-producer模块 [Source: architecture.md#核心组件设计]

**包结构建议**:
- 配置管理: `log-java-producer/src/main/java/org/logx/config/`
- 验证器: `log-java-producer/src/main/java/org/logx/config/validator/`
- 工厂类: `log-java-producer/src/main/java/org/logx/config/factory/`
- 示例文件: `log-java-producer/src/main/resources/examples/`
- 测试文件: `log-java-producer/src/test/java/org/logx/config/`

### Testing
**测试框架**: JUnit 5.10.1 [Source: architecture.md#技术栈表]
**断言库**: AssertJ 3.24.2 [Source: architecture.md#技术栈表]
**测试覆盖要求**: 单元测试覆盖率 > 90% [Source: architecture.md#测试覆盖]

**配置管理特定测试要求**:
- 配置读取优先级测试：不同配置源的覆盖逻辑
- 参数验证测试：各种无效配置的处理
- 热加载测试：配置文件变更的实时响应
- 错误恢复测试：配置失败时的回滚机制
- 多框架兼容性测试：Spring Boot、JSP等环境下的配置加载
- 安全性测试：敏感信息的保护和日志脱敏

**测试工具**: 使用Testcontainers进行配置验证的集成测试

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-20 | 1.0 | Initial story creation for config management framework | Bob (Scrum Master) |

## Dev Agent Record
_(This section is populated by the development agent during implementation)_

### Agent Model Used
_(To be filled by dev agent)_

### Debug Log References
_(To be filled by dev agent)_

### Completion Notes List
_(To be filled by dev agent)_

### File List
_(To be filled by dev agent)_

## QA Results
_(Results from QA Agent QA review of the completed story implementation)_