# Story 2.7: 异步引擎延迟阈值与稳定性改进

## Status
Draft

## Story
As a 平台工程师,
I want 将异步引擎的集成性能用例稳定化并参数化阈值,
so that 在常规 CI/容器环境下测试可信且不阻塞功能交付。

## Acceptance Criteria
1. 为 `AsyncEngineIntegrationTest.shouldMeetLatencyTarget` 增加预热（warm-up）与固定负载，降低抖动
2. 将关键阈值（消息数、延迟/吞吐目标）参数化，可通过系统属性或配置文件调整
3. 为性能类测试添加标签（如 `@Tag("perf")`）并提供 Maven Profile，默认在常规 CI 中跳过、在基准/夜跑中执行
4. 在当前容器/CI 环境下连续运行 3 次均通过；在 README/文档中补充使用说明与环境要求
5. 更新 `docs/issues/Epic2-AsyncEngineIntegrationTest-failure.md` 为“已计划修复”，并在完成后标记“已解决”

## Tasks / Subtasks
- [ ] Task 1: 测试稳定性增强（AC: 1）
  - [ ] 增加预热阶段与固定负载构造
  - [ ] 控制线程池/等待策略、关闭不必要日志
- [ ] Task 2: 阈值参数化（AC: 2）
  - [ ] 支持系统属性（如 `-Dperf.targetMessages=4000`、`-Dperf.p99LatencyMs=1`）
  - [ ] 回退到合理默认值，避免环境过严导致失败
- [ ] Task 3: 测试分层与标签（AC: 3）
  - [ ] 添加 `@Tag("perf")` 至性能用例
  - [ ] 新增 Maven Profile：`-Pperf-tests` 才运行性能测试，默认跳过
- [ ] Task 4: 稳定性验证（AC: 4）
  - [ ] 在当前容器/CI 环境下连续运行 3 次通过
  - [ ] 记录复现实验命令与结果
- [ ] Task 5: 文档与问题追踪（AC: 4,5）
  - [ ] README“已知问题”更新为“说明+使用方式”，保留指向文档
  - [ ] 更新 `docs/issues/Epic2-AsyncEngineIntegrationTest-failure.md` 状态

## Dev Notes
- 将性能验证与功能 CI 解耦（默认不跑 perf），在基准或夜跑环境启用 `-Pperf-tests`
- 保持目标一致性：PRD 中的吞吐/延迟目标应在基准环境验证；通用环境仅做合理下限校验

## Testing
- 选择性执行：`mvn -q -pl log-java-producer -Pperf-tests -Dtest=org.logx.integration.AsyncEngineIntegrationTest test`
- 非 perf 跑法（默认 CI）：`mvn -q -pl log-java-producer test`
- 连跑 3 次通过并记录 surefire 报告

## Change Log
| Date       | Version | Description                                   | Author |
|------------|---------|-----------------------------------------------|--------|
| 2025-09-22 | 1.0     | Draft 初版：定义性能用例稳定化与阈值参数化方案 | James  |

## Dev Agent Record
_(This section is populated by the development agent during implementation)_
